// Firestore Security Rules for Masterpiece Shawarma
// Deploy with: firebase deploy --only firestore:rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    function isValidOrder(data) {
      return data.size() > 0 &&
             'orderNumber' in data &&
             'items' in data &&
             'customer' in data &&
             'total' in data &&
             data.total is number &&
             data.total > 0 &&
             'paymentMethod' in data &&
             'status' in data;
    }
    
    function isValidPayment(data) {
      return 'method' in data &&
             'status' in data &&
             'reference' in data &&
             data.reference is string &&
             data.reference.size() > 0;
    }
    
    // ============================================
    // ORDERS - Only server can write
    // ============================================
    match /orders/{orderId} {
      // Anyone can read their own orders if authenticated
      // (For now, anyone can read all orders - add auth later)
      allow read: if true;
      
      // ONLY Cloud Functions can CREATE orders (server-side)
      allow create: if request.auth.uid != null &&
                       request.writeFields.hasAll(['orderNumber', 'items', 'customer', 'total']) &&
                       isValidOrder(request.resource.data) &&
                       isValidPayment(request.resource.data.payment);
      
      // Only admin can update/delete (add admin check later)
      allow update: if false;
      allow delete: if false;
      
      // Subcollection for order updates
      match /updates/{updateId} {
        allow read: if resource.data.orderId == orderId;
        allow create: if request.auth.uid != null;
      }
    }
    
    // ============================================
    // MENU - Public read, auth-only write
    // ============================================
    match /menu/{menuId} {
      allow read: if true; // Everyone can view menu
      allow create, update, delete: if false; // Only admin dashboard can modify
    }
    
    // ============================================
    // SETTINGS - Server-only
    // ============================================
    match /settings/{setting} {
      allow read: if true;
      allow write: if false;
    }
    
    // ============================================
    // DENY ALL BY DEFAULT
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
